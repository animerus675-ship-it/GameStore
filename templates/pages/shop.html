{% extends "layout/base.html" %}

{% block title %}BBGame - Shop{% endblock %}

{% block content %}
<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h3>Our Shop</h3>
        <span class="breadcrumb"><a href="{% url 'pages:home' %}">Home</a> &gt; Our Shop</span>
      </div>
    </div>
  </div>
</div>

<div class="section trending">
  <div class="container">
    <form method="get" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4 col-md-6">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search by title"
            value="{{ q }}"
            data-live-search
            data-live-search-target="[data-search-item]"
          >
        </div>
        <div class="col-lg-3 col-md-6">
          <select name="sort" class="form-select" data-sort>
            <option value="">Newest first</option>
            <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest first</option>
            <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: low to high</option>
            <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: high to low</option>
          </select>
        </div>
        <div class="col-lg-3 col-md-6 d-grid">
          <button
            type="button"
            class="btn btn-outline-primary"
            data-bs-toggle="collapse"
            data-bs-target="#shopCategoriesCollapse"
            aria-expanded="{% if platform or publisher or tag or rating %}true{% else %}false{% endif %}"
            aria-controls="shopCategoriesCollapse"
          >
            Categories
          </button>
        </div>
        <div class="col-lg-2 col-md-6 d-grid">
          <button type="submit" class="btn btn-primary">Search</button>
        </div>
      </div>

      <div id="shopCategoriesCollapse" class="collapse mt-3 {% if platform or publisher or tag or rating %}show{% endif %}">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <select name="platform" class="form-select">
              <option value="">All platforms</option>
              {% for item in platforms %}
                <option value="{{ item.slug }}" {% if platform == item.slug %}selected{% endif %}>{{ item.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-lg-3 col-md-6">
            <select name="publisher" class="form-select">
              <option value="">All publishers</option>
              {% for item in publishers %}
                <option value="{{ item.slug }}" {% if publisher == item.slug %}selected{% endif %}>{{ item.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-lg-3 col-md-6">
            <select name="tag" class="form-select">
              <option value="">All tags</option>
              {% for item in tags %}
                <option value="{{ item.slug }}" {% if tag == item.slug %}selected{% endif %}>{{ item.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-lg-3 col-md-6">
            <select name="rating" class="form-select">
              <option value="">All ratings</option>
              <option value="4.5" {% if rating == '4.5' %}selected{% endif %}>4.5+ stars</option>
              <option value="4" {% if rating == '4' %}selected{% endif %}>4.0+ stars</option>
              <option value="3" {% if rating == '3' %}selected{% endif %}>3.0+ stars</option>
              <option value="2" {% if rating == '2' %}selected{% endif %}>2.0+ stars</option>
              <option value="1" {% if rating == '1' %}selected{% endif %}>1.0+ stars</option>
            </select>
          </div>
        </div>
      </div>
    </form>

    <div class="row" data-sort-container>
      {% for game in games %}
        <div
          class="col-lg-4 col-md-6 mb-4"
          data-search-item
          data-sort-item
          data-title="{{ game.title|lower }}"
          data-price="{{ game.price }}"
          data-rating="{{ game.average_rating|default_if_none:'0' }}"
        >
          <div class="item h-100">
            <a class="steam-card" href="{% url 'pages:product_detail' game.slug %}" aria-label="Open {{ game.title }}">
              <div class="steam-card__thumb">
                {% if game.primary_image_url %}
                  <img
                    src="{{ game.primary_image_url }}"
                    alt="{{ game.primary_image_alt }}"
                    class="steam-card__image game-thumb"
                    loading="lazy"
                    onerror="this.style.display='none'; this.nextElementSibling.classList.remove('d-none');"
                  >
                  <div class="steam-card__placeholder d-none">NO IMAGE</div>
                {% else %}
                  <div class="steam-card__placeholder">NO IMAGE</div>
                {% endif %}
              </div>
              <div class="steam-card__info">
                <div class="steam-card__publisher">{{ game.publisher.name|default:"No Publisher" }}</div>
                <div class="steam-card__title">{{ game.title }}</div>
                <div class="steam-card__meta">
                  {% if game.discount_percent > 0 %}
                    <span class="old-price">${{ game.price }}</span>
                    <span class="new-price">${{ game.discounted_price }}</span>
                    <span class="discount-badge">-{{ game.discount_percent }}%</span>
                  {% else %}
                    {% if game.price %}
                      <span class="steam-card__price">${{ game.price }}</span>
                    {% else %}
                      <span class="steam-card__price">Free</span>
                    {% endif %}
                  {% endif %}
                  <span class="steam-card__rating">Rating: {{ game.average_rating|default_if_none:"0"|floatformat:1 }}</span>
                </div>
              </div>
            </a>
          </div>
        </div>
      {% empty %}
        <div class="col-12">
          <p>No games found.</p>
        </div>
      {% endfor %}
    </div>

    {% if games.paginator.num_pages > 1 %}
      <div class="row">
        <div class="col-lg-12">
          <ul class="pagination">
            {% if games.has_previous %}
              <li>
                <a href="?{% if query_string %}{{ query_string }}&amp;{% endif %}page={{ games.previous_page_number }}">&lt;</a>
              </li>
            {% endif %}

            {% for page_num in games.paginator.page_range %}
              <li>
                <a
                  href="?{% if query_string %}{{ query_string }}&amp;{% endif %}page={{ page_num }}"
                  class="{% if games.number == page_num %}is_active{% endif %}"
                >{{ page_num }}</a>
              </li>
            {% endfor %}

            {% if games.has_next %}
              <li>
                <a href="?{% if query_string %}{{ query_string }}&amp;{% endif %}page={{ games.next_page_number }}">&gt;</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
