{% extends "layout/base.html" %}

{% block title %}{{ game.title }}{% endblock %}

{% block content %}
<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h3>{{ game.title }}</h3>
        <span class="breadcrumb">
          <a href="{% url 'home' %}">Home</a> &gt;
          <a href="{% url 'shop' %}">Shop</a> &gt;
          {{ game.title }}
        </span>
      </div>
    </div>
  </div>
</div>

<div class="single-product section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <h4>{{ game.title }}</h4>
        {% if game.cover %}
          <img src="{{ game.cover.url }}" alt="{{ game.title }}" class="product-image">
        {% endif %}
        {% if game.discount_percent > 0 %}
          <div class="mb-2">
            <span class="old-price">${{ game.price }}</span>
            <span class="new-price">${{ game.discounted_price }}</span>
            <span class="discount-badge">-{{ game.discount_percent }}%</span>
          </div>
        {% else %}
          <span class="price">${{ game.price }}</span>
        {% endif %}
        <p class="mt-3">{{ game.description }}</p>
        <ul>
          <li><span>Publisher:</span> {{ game.publisher.name|default:"No Publisher" }}</li>
          <li>
            <span>Genres:</span>
            {% for item in game.genres.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li>
            <span>Platforms:</span>
            {% for item in game.platforms.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li>
            <span>Tags:</span>
            {% for item in game.tags.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li><span>Average rating:</span> {{ avg_rating|floatformat:1 }}</li>
          <li><span>Reviews:</span> {{ reviews_count }}</li>
        </ul>

        {% if user.is_authenticated %}
          <div class="mt-3">
            <a href="{% url 'cart_add' game.slug %}" class="btn btn-warning">Add to cart</a>
          </div>

          <form
            method="post"
            action="{% url 'toggle_favorite' slug=game.slug %}"
            class="mt-3"
            data-favorite-form
          >
            {% csrf_token %}
            <button
              type="submit"
              class="btn btn-primary"
              data-favorite-toggle
              data-url="{% url 'toggle_favorite' slug=game.slug %}"
              data-added-text="Remove from favorites"
              data-removed-text="Add to favorites"
            >
              {% if is_favorite %}Remove from favorites{% else %}Add to favorites{% endif %}
            </button>
          </form>
        {% else %}
          <p class="mt-3">
            <a href="{% url 'login' %}?next={{ request.path|urlencode }}">Log in</a>, to add this game to favorites.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="more-info">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h4 class="mb-3">Reviews</h4>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'upsert_review' slug=game.slug %}" class="mb-4">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-2">
                <select name="rating" class="form-select" required>
                  <option value="">Rating</option>
                  <option value="1" {% if user_review and user_review.rating == 1 %}selected{% endif %}>1</option>
                  <option value="2" {% if user_review and user_review.rating == 2 %}selected{% endif %}>2</option>
                  <option value="3" {% if user_review and user_review.rating == 3 %}selected{% endif %}>3</option>
                  <option value="4" {% if user_review and user_review.rating == 4 %}selected{% endif %}>4</option>
                  <option value="5" {% if user_review and user_review.rating == 5 %}selected{% endif %}>5</option>
                </select>
              </div>
              <div class="col-md-8">
                <textarea name="text" class="form-control" rows="2" placeholder="Your review...">{% if user_review %}{{ user_review.text }}{% endif %}</textarea>
              </div>
              <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Save</button>
              </div>
            </div>
          </form>
        {% else %}
          <p><a href="{% url 'login' %}?next={{ request.path|urlencode }}">Log in</a>, to leave a review.</p>
        {% endif %}

        <div class="list-group">
          {% for review in reviews %}
            <div class="list-group-item mb-2">
              <div><strong>{{ review.user.username }}</strong> - {{ review.rating }}/5</div>
              <div>{{ review.text }}</div>
              <small>{{ review.created_at }}</small>
            </div>
          {% empty %}
            <p>No reviews yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
