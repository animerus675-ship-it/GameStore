{% extends "layout/base.html" %}

{% block title %}{{ game.title }}{% endblock %}

{% block content %}
<div class="page-heading header-text">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h3>{{ game.title }}</h3>
        <span class="breadcrumb">
          <a href="{% url 'home' %}">Home</a> &gt;
          <a href="{% url 'shop' %}">Shop</a> &gt;
          {{ game.title }}
        </span>
      </div>
    </div>
  </div>
</div>

<div class="single-product section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <h4>{{ game.title }}</h4>
        <span class="price">${{ game.price }}</span>
        <p class="mt-3">{{ game.description }}</p>
        <ul>
          <li><span>Publisher:</span> {{ game.publisher.name|default:"No Publisher" }}</li>
          <li>
            <span>Genres:</span>
            {% for item in game.genres.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li>
            <span>Platforms:</span>
            {% for item in game.platforms.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li>
            <span>Tags:</span>
            {% for item in game.tags.all %}
              {{ item.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              -
            {% endfor %}
          </li>
          <li><span>Average rating:</span> {{ avg_rating|floatformat:1 }}</li>
          <li><span>Reviews:</span> {{ reviews_count }}</li>
        </ul>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'toggle_favorite' slug=game.slug %}" class="mt-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">
              {% if is_favorite %}Убрать из избранного{% else %}В избранное{% endif %}
            </button>
          </form>
        {% else %}
          <p class="mt-3">
            <a href="/admin/login/?next={{ request.path|urlencode }}">Войдите</a>, чтобы добавить в избранное.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="more-info">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h4 class="mb-3">Отзывы</h4>

        {% if user.is_authenticated %}
          <form method="post" action="{% url 'upsert_review' slug=game.slug %}" class="mb-4">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-2">
                <select name="rating" class="form-select" required>
                  <option value="">Оценка</option>
                  <option value="1" {% if user_review and user_review.rating == 1 %}selected{% endif %}>1</option>
                  <option value="2" {% if user_review and user_review.rating == 2 %}selected{% endif %}>2</option>
                  <option value="3" {% if user_review and user_review.rating == 3 %}selected{% endif %}>3</option>
                  <option value="4" {% if user_review and user_review.rating == 4 %}selected{% endif %}>4</option>
                  <option value="5" {% if user_review and user_review.rating == 5 %}selected{% endif %}>5</option>
                </select>
              </div>
              <div class="col-md-8">
                <textarea name="text" class="form-control" rows="2" placeholder="Ваш отзыв...">{% if user_review %}{{ user_review.text }}{% endif %}</textarea>
              </div>
              <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Сохранить</button>
              </div>
            </div>
          </form>
        {% else %}
          <p><a href="/admin/login/?next={{ request.path|urlencode }}">Войдите</a>, чтобы оставить отзыв.</p>
        {% endif %}

        <div class="list-group">
          {% for review in reviews %}
            <div class="list-group-item mb-2">
              <div><strong>{{ review.user.username }}</strong> - {{ review.rating }}/5</div>
              <div>{{ review.text }}</div>
              <small>{{ review.created_at }}</small>
            </div>
          {% empty %}
            <p>Отзывов пока нет.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
